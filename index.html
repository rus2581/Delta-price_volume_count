<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Trades Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
</head>
<body>
    <label for="coinSearch">Search Coin:</label>
    <input type="text" id="coinSearch" placeholder="Type to search..." oninput="filterCoins()">
    
    <label for="coinSelect">Select Coin:</label>
    <select id="coinSelect" onchange="updateSymbol()">
        <option value="" disabled selected>Loading...</option>
    </select>

    <label for="startTime">Start Time:</label>
    <input type="datetime-local" id="startTime">
    
    <label for="endTime">End Time:</label>
    <input type="datetime-local" id="endTime">
    
    <button onclick="fetchAllTrades()">Update Charts</button>

    <label for="autoUpdate">Auto Update:</label>
    <select id="autoUpdate" onchange="toggleAutoUpdate()">
        <option value="0">Off</option>
        <option value="30">30 sec</option>
        <option value="60">1 min</option>
    </select>
    
    <canvas id="combinedChart"></canvas>

    <script>
        let combinedChart;
        let symbol = ""; // По умолчанию пустой
        let autoUpdateInterval;
        let coinList = [];

        async function fetchCoins() {
            try {
                console.log("Fetching futures coins...");
                const response = await fetch("https://fapi.binance.com/fapi/v1/exchangeInfo");
                const data = await response.json();

                if (!data.symbols) {
                    console.error("API response does not contain symbols:", data);
                    return;
                }

                // Загружаем все активные фьючерсные монеты
                coinList = data.symbols
                    .filter(s => s.status === "TRADING")
                    .map(s => s.symbol);

                console.log("Total futures coins fetched:", coinList.length);
                populateCoinSelect();
            } catch (error) {
                console.error("Error fetching futures coins:", error);
            }
        }

        function populateCoinSelect() {
            const coinSelect = document.getElementById('coinSelect');
            coinSelect.innerHTML = '<option value="" disabled selected>Select a coin</option>'; // Очищаем список

            coinList.forEach(coin => {
                const option = document.createElement('option');
                option.value = coin;
                option.textContent = coin;
                coinSelect.appendChild(option);
            });

            console.log("Dropdown populated with", coinList.length, "coins");
        }

        function filterCoins() {
            const input = document.getElementById('coinSearch').value.toUpperCase();
            const coinSelect = document.getElementById('coinSelect');
            const options = coinSelect.getElementsByTagName('option');

            for (let i = 1; i < options.length; i++) {
                const option = options[i];
                option.style.display = option.value.includes(input) ? "" : "none";
            }
        }

        function updateSymbol() {
            symbol = document.getElementById('coinSelect').value;
            console.log("Selected symbol:", symbol);
        }

        async function fetchAllTrades() {
            if (!symbol) {
                alert("Please select a coin first.");
                return;
            }
            const startTime = new Date(document.getElementById('startTime').value).getTime();
            const endTime = new Date(document.getElementById('endTime').value).getTime();
            if (!startTime || !endTime) {
                alert("Please select both start and end time.");
                return;
            }

            let allTrades = [], currentStartTime = startTime;
            try {
                while (currentStartTime < endTime) {
                    const url = `https://fapi.binance.com/fapi/v1/aggTrades?symbol=${symbol}&startTime=${currentStartTime}&endTime=${endTime}&limit=1000`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const trades = await response.json();
                    if (trades.length === 0) break;
                    allTrades = allTrades.concat(trades);
                    currentStartTime = trades[trades.length - 1].T + 1;
                }
                processTrades(allTrades);
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("An error occurred while fetching data.");
            }
        }

        function processTrades(trades) {
            const priceData = trades.map(t => ({ x: t.T, y: parseFloat(t.p) }));
            let accumulatedVolume = 0, accumulatedOrders = 0;
            const volumeData = trades.map(t => {
                accumulatedVolume += parseFloat(t.q) * (t.m ? -1 : 1);
                return { x: t.T, y: accumulatedVolume };
            });
            const orderData = trades.map(t => {
                accumulatedOrders += t.m ? -1 : 1;
                return { x: t.T, y: accumulatedOrders };
            });
            drawCombinedChart(priceData, volumeData, orderData);
        }

        function drawCombinedChart(priceData, volumeData, orderData) {
            const ctx = document.getElementById('combinedChart');
            if (combinedChart) combinedChart.destroy();
            combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Price', data: priceData, borderColor: 'blue', yAxisID: 'y', pointRadius: 0 },
                        { label: 'Delta Volume', data: volumeData, borderColor: 'red', yAxisID: 'y1', pointRadius: 0 },
                        { label: 'Delta Order', data: orderData, borderColor: 'green', yAxisID: 'y2', pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute' } },
                        y: { position: 'left', title: { display: true, text: 'Price' } },
                        y1: { position: 'right', title: { display: true, text: 'Delta Volume' }, grid: { drawOnChartArea: false } },
                        y2: { position: 'right', title: { display: true, text: 'Delta Order' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function toggleAutoUpdate() {
            const interval = parseInt(document.getElementById('autoUpdate').value) * 1000;
            if (autoUpdateInterval) clearInterval(autoUpdateInterval);
            if (interval > 0) {
                autoUpdateInterval = setInterval(fetchAllTrades, interval);
            }
        }

        fetchCoins();
    </script>
</body>
</html>
